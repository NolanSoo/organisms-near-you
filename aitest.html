<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        html {
            height: 100%;
            width: 100%;
        }
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }
        .result-label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .result-destroyed {
            color: red;
        }
        .result-weak {
            color: orange;
        }
        .result-strong {
            color: green;
        }
        #environmental-score {
            font-weight: bold;
        }
        #image-container img {
            width: 500px;
            margin: 5px;
        }
    </style>
</head>
<body>

    Organisms Near You AI (Beta)
    <br>
    This tool is used with Organisms Near You to analyze the sustainability of a location from an image
    <br>
    <a href="index.html" id="k"><button>Organisms Near You</button></a>
    <a href="game.html" id="k2"><button>Explore Our World</button></a>
    <br>
    <input accept="image/*" type='file' id="input_button" multiple />
    <br>
    <div id="image-container"></div>
    <br>
    <button onclick="predict()">predict</button>
    <br>
    <p id="result">
        <span class="result-label">Result:</span>
        <span id="result-main"></span>
    </p>
    <p id="result2">
        <span class="result-label">Destroyed %:</span>
        <span id="result-destroyed"></span>
    </p>
    <p id="result3">
        <span class="result-label">Weak %:</span>
        <span id="result-weak"></span>
    </p>
    <p id="result4">
        <span class="result-label">Strong %:</span>
        <span id="result-strong"></span>
    </p>
    <p id="environmental-score"></p>

 <script>
    const imageContainer = document.getElementById('image-container');
    const inputButton = document.getElementById('input_button');
    const imageElements = [];

    inputButton.onchange = evt => {
        imageContainer.innerHTML = ''; // Clear previous images
        document.getElementById("result-main").innerHTML = " ";
        document.getElementById("result-destroyed").innerHTML = " ";
        document.getElementById("result-weak").innerHTML = " ";
        document.getElementById("result-strong").innerHTML = " ";
        const files = Array.from(inputButton.files);
        files.forEach(file => {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            imageContainer.appendChild(img);
            imageElements.push(img);
        });
    };

    async function predict() {
        var model = await tf.loadGraphModel('./model.json');

        let classScores = [];
        for (const img of imageElements) {
            let example = tf.browser.fromPixels(img, 3).cast('float32');
            example = example.reshape([1, example.shape[0], example.shape[1], example.shape[2]]);
            let prediction = await model.predict(example);
            let scores = await prediction.data();
            classScores.push(scores);
        }

        // Handle case where there are no images
        if (classScores.length === 0) {
            return;
        }

        // Calculate average class scores
        let numClasses = classScores[0].length;
        let averageScores = new Array(numClasses).fill(0);
        
        classScores.forEach(scores => {
            scores.forEach((score, i) => {
                averageScores[i] += score;
            });
        });

        averageScores = averageScores.map(score => score / classScores.length);

        // Identify the class with the highest average score
        let maxScoreId = averageScores.indexOf(Math.max(...averageScores));
        let classes = ["Destroyed", "Strong", "Weak"];

        // Calculate percentages
        let total = averageScores.reduce((a, b) => a + b, 0);
        let percentages = averageScores.map(score => (score / total * 100).toFixed(2));

        // Update result text
        document.getElementById("result-main").innerHTML = classes[maxScoreId];
        document.getElementById("result-destroyed").innerHTML = percentages[0] + "%";
        document.getElementById("result-weak").innerHTML = percentages[2] + "%";
        document.getElementById("result-strong").innerHTML = percentages[1] + "%";

        // Environmental Score Calculation
        let destroyedPercentage = parseFloat(percentages[0]);
        let weakPercentage = parseFloat(percentages[2]);
        let strongPercentage = parseFloat(percentages[1]);

        let environmentalScore = (destroyedPercentage * 0) + (weakPercentage * 0.285) + (strongPercentage * 1);
        environmentalScore = Math.min(Math.max(environmentalScore, 0), 100).toFixed(2);

        // Display Environmental Score
        let scoreElement = document.getElementById("environmental-score");
        scoreElement.innerHTML = `Environmental Score: ${environmentalScore}%`;

        // Color-code Environmental Score
        if (environmentalScore < 50) {
            scoreElement.style.color = 'red';
        } else if (environmentalScore < 70) {
            scoreElement.style.color = 'orange';
        } else {
            scoreElement.style.color = 'green';
        }
    }
</script>
</body>
</html>

